name: Deploy Gateway Infrastructure

on:
  push:
    branches:
      - main  # 当 main 分支有推送时触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          # 从 GitHub Secrets 中读取变量
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          
          # 在服务器上执行的脚本
          script: |
            # 1. 进入项目目录 (如果不存在则创建)
            sudo mkdir -p ${{ secrets.PROJECT_PATH }}
            cd ${{ secrets.PROJECT_PATH }}
            
            # 2. 将新配置从 GitHub Runner 同步到服务器
            # (这里我们使用 rsync，它更高效)
            # 我们需要先安装 ssh-agent 来安全地 rsync
            # (注意：appleboy/ssh-action 已经帮我们处理了 SSH 链接，
            #  但我们需要把本地文件（Runner上的）传到远程（Server上的）)
            # 
            # 修正：appleboy/ssh-action 并不用于同步文件。
            # 我们用 scp action 来同步文件，用 ssh action 来执行命令。
            echo "Deployment finished." # 占位符，我们将使用下面的 action

      - name: Sync Files to Server via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "docker-compose.yml,nginx_config/" # 要复制的文件和目录
          target: ${{ secrets.PROJECT_PATH }} # 目标服务器路径
          strip_components: 0 # 保持目录结构

      - name: Run Docker Compose on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # 确保 docker-compose 命令可用 (假设已安装)
            # 启动或更新服务
            docker-compose up -d
            
            # 安全地重载 Nginx 配置
            docker-compose exec gateway-nginx nginx -s reload
            
            echo "Gateway deployment successful."
