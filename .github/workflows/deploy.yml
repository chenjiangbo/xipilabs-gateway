name: Deploy Gateway Infrastructure

on:
  push:
    branches:
      - main  # 当 main 分支有推送时触发
  schedule:
    - cron: "0 2 * * *"  # 每天 02:00 UTC 自动执行，便于定期续期证书

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Remote Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            mkdir -p ${{ secrets.PROJECT_PATH }}

      - name: Sync Files to Server via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "docker-compose.yml,nginx_config/,auth_service/" # 同步配置文件
          target: ${{ secrets.PROJECT_PATH }} # 目标服务器路径
          strip_components: 0 # 保持目录结构

      - name: Run Docker Compose on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.PROJECT_PATH }}

            # 确保证书目录存在（证书文件本身不从 GitHub 同步）
            mkdir -p data/certbot/conf data/certbot/www

            # 启动或更新网关及所有依赖服务，并注入 JWT 密钥
            JWT_SECRET=${{ secrets.JWT_SECRET }} docker compose up -d

            # 尝试静默续期证书（首次部署尚未申请证书时会提示“无可续期”）
            docker compose run --rm --no-deps certbot renew --webroot -w /var/www/certbot --quiet || true

            # 重载 Nginx 以确保读取最新证书；如果容器刚启动则执行重启兜底
            docker compose exec gateway-nginx nginx -s reload || docker compose restart gateway-nginx

            echo "Gateway deployment successful."
