name: Deploy Gateway Infrastructure

on:
  push:
    branches:
      - main  # 当 main 分支有推送时触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Remote Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            mkdir -p ${{ secrets.PROJECT_PATH }}

      - name: Sync Files to Server via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "docker-compose.yml,nginx_config/" # 要复制的文件和目录
          target: ${{ secrets.PROJECT_PATH }} # 目标服务器路径
          strip_components: 0 # 保持目录结构

      - name: Run Docker Compose on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.PROJECT_PATH }}

            # 启动或更新服务
            docker compose up -d

            # 安全地重载 Nginx 配置，如果容器刚启动则执行重启兜底
            docker compose exec gateway-nginx nginx -s reload || docker compose restart gateway-nginx

            echo "Gateway deployment successful."
