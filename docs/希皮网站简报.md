<font style="color:rgb(27, 28, 29);">â€œä»»åŠ¡ç®€æŠ¥â€ï¼š</font>

<font style="color:rgb(27, 28, 29);">åœ¨è¿™ä»½ç®€æŠ¥çš„æœ«å°¾ï¼Œ</font>**<font style="color:rgb(27, 28, 29);">æˆ‘è‡ªå·±ï¼ˆé™ˆæ±Ÿæ³¢ï¼‰çš„â€œæ‰‹åŠ¨é…ç½®æŒ‡å—â€ï¼Œè¿™éƒ¨åˆ†éœ€è¦æˆ‘äº²è‡ªæ“ä½œ</font>**<font style="color:rgb(27, 28, 29);">ï¼Œç”¨äºè§£å†³æ‚¨â€œä¸å¸Œæœ›æ‰‹åŠ¨é…ç½®å˜é‡â€çš„é—®é¢˜ã€‚</font>

---

### <font style="color:rgb(27, 28, 29);">ğŸš€</font><font style="color:rgb(27, 28, 29);"> ä»»åŠ¡ç®€æŠ¥ï¼šä¸º AI Coder</font>
<font style="color:rgb(27, 28, 29);">ä½ å¥½ï¼Œè¯·ä¸ºæˆ‘çš„æ–° GitHub ä»“åº“ </font>`<font style="color:rgb(68, 71, 70);">xipilabs-gateway</font>`<font style="color:rgb(27, 28, 29);"> åˆå§‹åŒ–é¡¹ç›®ç»“æ„ã€‚</font>

<font style="color:rgb(27, 28, 29);">è¿™ä¸ªé¡¹ç›®æ˜¯æ•´ä¸ª </font>`<font style="color:rgb(68, 71, 70);">xipilabs.com</font>`<font style="color:rgb(27, 28, 29);"> ç«™ç¾¤çš„</font>**<font style="color:rgb(27, 28, 29);">ä¸»å…¥å£ç½‘å…³</font>**<font style="color:rgb(27, 28, 29);">ï¼Œä½¿ç”¨ Nginx å’Œ Docker Compose æ¥ç®¡ç†æ‰€æœ‰æœåŠ¡çš„åå‘ä»£ç†å’Œè·¯ç”±ã€‚</font>

#### <font style="color:rgb(27, 28, 29);">1. é¡¹ç›®åŸºç¡€å˜é‡</font>
+ **<font style="color:rgb(27, 28, 29);">éƒ¨ç½²è·¯å¾„ (æœåŠ¡å™¨ç«¯):</font>**`<font style="color:rgb(68, 71, 70);">/workspace/gateway</font>`<font style="color:rgb(27, 28, 29);"> (å¯¹åº” </font>`<font style="color:rgb(68, 71, 70);">PROJECT_PATH</font>`<font style="color:rgb(27, 28, 29);">)</font>
+ **<font style="color:rgb(27, 28, 29);">æœåŠ¡å™¨ä¸»æœº:</font>**`<font style="color:rgb(68, 71, 70);">8.216.37.78</font>`<font style="color:rgb(27, 28, 29);"> (å¯¹åº” </font>`<font style="color:rgb(68, 71, 70);">SERVER_HOST</font>`<font style="color:rgb(27, 28, 29);">)</font>
+ **<font style="color:rgb(27, 28, 29);">æœåŠ¡å™¨ç”¨æˆ·:</font>**`<font style="color:rgb(68, 71, 70);">deployer</font>`<font style="color:rgb(27, 28, 29);"> (å¯¹åº” </font>`<font style="color:rgb(68, 71, 70);">SERVER_USER</font>`<font style="color:rgb(27, 28, 29);">)</font>
+ **<font style="color:rgb(27, 28, 29);">æœåŠ¡å™¨SSHç§é’¥ (GitHub Secret åç§°):</font>**`<font style="color:rgb(68, 71, 70);">SERVER_SSH_KEY</font>`<font style="color:rgb(27, 28, 29);"> (å¯¹åº” </font>`<font style="color:rgb(68, 71, 70);">japan-server-keyæ–‡ä»¶ï¼Œéœ€è¦ä½ åœ¨æœ¬æœºæ‰¾ä¸€ä¸‹</font>`<font style="color:rgb(27, 28, 29);">)</font>

#### <font style="color:rgb(27, 28, 29);">2. è¯·åˆ›å»ºä»¥ä¸‹é¡¹ç›®æ–‡ä»¶ç»“æ„</font>
```plain
xipilabs-gateway/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ deploy.yml
â”œâ”€â”€ nginx_config/
â”‚   â””â”€â”€ xipilabs.conf
â””â”€â”€ docker-compose.yml
```

---

#### <font style="color:rgb(27, 28, 29);">3. æ–‡ä»¶å†…å®¹</font>
<font style="color:rgb(27, 28, 29);">è¯·ä½¿ç”¨ä»¥ä¸‹å†…å®¹å¡«å……æ–‡ä»¶ï¼š</font>

<font style="color:rgb(27, 28, 29);">æ–‡ä»¶ 1: docker-compose.yml</font>

<font style="color:rgb(27, 28, 29);">(è´Ÿè´£ç¼–æ’ Nginx ç½‘å…³å’Œæ‰€æœ‰åº”ç”¨)</font>

<font style="color:rgb(68, 71, 70);">YAML</font>

```plain
version: '3.8'

services:
  # 1. ç½‘å…³ Nginx (æ€»å…¥å£)
  gateway-nginx:
    image: nginx:latest
    container_name: gateway-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # æŒ‚è½½ Nginx é…ç½®
      - ./nginx_config:/etc/nginx/conf.d
      # æŒ‚è½½ SSL è¯ä¹¦ (ä¸ºæœªæ¥ HTTPS é¢„ç•™)
      - /etc/letsencrypt:/etc/letsencrypt 
    networks:
      - xipi-network
    restart: always

  # 2. å®˜ç½‘ (www.xipilabs.com)
  # æ³¨æ„ï¼šè¿™æ˜¯ç¤ºä¾‹ï¼Œæ‚¨éœ€è¦ç¡®ä¿æ‚¨çš„ www-repo éƒ¨ç½²æ—¶
  # ä¹Ÿå°†å®¹å™¨åŠ å…¥äº† 'xipi-network'
  www-app:
    image: xipilabs/www-image:latest # ç¤ºä¾‹ï¼šè¯·æ›¿æ¢æˆæ‚¨çœŸå®çš„å®˜ç½‘é•œåƒ
    container_name: www-app
    # å®˜ç½‘åº”ç”¨ä¸éœ€è¦æš´éœ² ports åˆ°ä¸»æœº
    # Nginx é€šè¿‡å†…éƒ¨ç½‘ç»œè®¿é—®å®ƒ
    expose:
      - "3210" # å®˜ç½‘åœ¨å®¹å™¨å†…è¿è¡Œäº 3210 ç«¯å£
    networks:
      - xipi-network
    restart: always

  # 3. Taleweave (taleweave.xipilabs.com)
  taleweave-app:
    image: xipilabs/taleweave-image:latest # ç¤ºä¾‹ï¼šè¯·æ›¿æ¢æˆæ‚¨çœŸå®çš„ Taleweave é•œåƒ
    container_name: taleweave-app
    expose:
      - "3000" # Taleweave åœ¨å®¹å™¨å†…è¿è¡Œäº 3000 ç«¯å£
    networks:
      - xipi-network
    restart: always

# å…±äº«ç½‘ç»œï¼Œè®© Nginx å¯ä»¥é€šè¿‡æœåŠ¡åè®¿é—®åº”ç”¨
networks:
  xipi-network:
    driver: bridge
```

<font style="color:rgb(27, 28, 29);">æ–‡ä»¶ 2: nginx_config/xipilabs.conf</font>

<font style="color:rgb(27, 28, 29);">(Nginx è·¯ç”±é…ç½®)</font>

<font style="color:rgb(68, 71, 70);">Nginx</font>

```plain
# 1. å®˜ç½‘ (www.xipilabs.com)
server {
    listen 80;
    server_name www.xipilabs.com xipilabs.com;

    location / {
        # è½¬å‘åˆ° docker-compose.yml ä¸­å®šä¹‰çš„ "www-app" æœåŠ¡çš„ 8080 ç«¯å£
        proxy_pass http://www-app:8080; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 2. Taleweave (taleweave.xipilabs.com)
server {
    listen 80;
    server_name taleweave.xipilabs.com;

    location / {
        # è½¬å‘åˆ° "taleweave-app" æœåŠ¡çš„ 3000 ç«¯å£
        proxy_pass http://taleweave-app:3000; 

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

<font style="color:rgb(27, 28, 29);">æ–‡ä»¶ 3: .github/workflows/deploy.yml</font>

<font style="color:rgb(27, 28, 29);">(GitHub Action è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬)</font>

<font style="color:rgb(68, 71, 70);">YAML</font>

```plain
name: Deploy Gateway Infrastructure

on:
  push:
    branches:
      - main  # å½“ main åˆ†æ”¯æœ‰æ¨é€æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          # ä» GitHub Secrets ä¸­è¯»å–å˜é‡
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„è„šæœ¬
          script: |
            # 1. è¿›å…¥é¡¹ç›®ç›®å½• (å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º)
            sudo mkdir -p ${{ secrets.PROJECT_PATH }}
            cd ${{ secrets.PROJECT_PATH }}
            
            # 2. å°†æ–°é…ç½®ä» GitHub Runner åŒæ­¥åˆ°æœåŠ¡å™¨
            # (è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ rsyncï¼Œå®ƒæ›´é«˜æ•ˆ)
            # æˆ‘ä»¬éœ€è¦å…ˆå®‰è£… ssh-agent æ¥å®‰å…¨åœ° rsync
            # (æ³¨æ„ï¼šappleboy/ssh-action å·²ç»å¸®æˆ‘ä»¬å¤„ç†äº† SSH é“¾æ¥ï¼Œ
            #  ä½†æˆ‘ä»¬éœ€è¦æŠŠæœ¬åœ°æ–‡ä»¶ï¼ˆRunnerä¸Šçš„ï¼‰ä¼ åˆ°è¿œç¨‹ï¼ˆServerä¸Šçš„ï¼‰)
            # 
            # ä¿®æ­£ï¼šappleboy/ssh-action å¹¶ä¸ç”¨äºåŒæ­¥æ–‡ä»¶ã€‚
            # æˆ‘ä»¬ç”¨ scp action æ¥åŒæ­¥æ–‡ä»¶ï¼Œç”¨ ssh action æ¥æ‰§è¡Œå‘½ä»¤ã€‚
            echo "Deployment finished." # å ä½ç¬¦ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸‹é¢çš„ action

      - name: Sync Files to Server via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "docker-compose.yml,nginx_config/" # è¦å¤åˆ¶çš„æ–‡ä»¶å’Œç›®å½•
          target: ${{ secrets.PROJECT_PATH }} # ç›®æ ‡æœåŠ¡å™¨è·¯å¾„
          strip_components: 0 # ä¿æŒç›®å½•ç»“æ„

      - name: Run Docker Compose on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # ç¡®ä¿ docker-compose å‘½ä»¤å¯ç”¨ (å‡è®¾å·²å®‰è£…)
            # å¯åŠ¨æˆ–æ›´æ–°æœåŠ¡
            docker-compose up -d
            
            # å®‰å…¨åœ°é‡è½½ Nginx é…ç½®
            docker-compose exec gateway-nginx nginx -s reload
            
            echo "Gateway deployment successful."
```

---

### <font style="color:rgb(27, 28, 29);">âš ï¸</font><font style="color:rgb(27, 28, 29);"> æ³¨æ„ï¼šç»™é™ˆæ±Ÿæ³¢çš„â€œæ‰‹åŠ¨é…ç½®æŒ‡å—â€</font>
<font style="color:rgb(27, 28, 29);">é™ˆå…ˆç”Ÿï¼Œæ‚¨å¥½ã€‚</font>

<font style="color:rgb(27, 28, 29);">æ‚¨æåˆ°â€œå¸Œæœ›èƒ½å¤Ÿè‡ªåŠ¨åœ¨ github ä¸Šåº”ç”¨è¿™äº›å˜é‡ï¼Œä¸è¦æˆ‘æ‰‹åŠ¨ä¸€ä¸ªä¸ªçš„é…ç½®â€ã€‚</font>

<font style="color:rgb(27, 28, 29);">æˆ‘å®Œå…¨ç†è§£æ‚¨çš„æ„æ€ã€‚</font>**<font style="color:rgb(27, 28, 29);">ä¸ºäº†å®ç°â€œè‡ªåŠ¨åŒ–â€ï¼Œæ‚¨éœ€è¦â€œæ‰‹åŠ¨ä¸€æ¬¡â€</font>**<font style="color:rgb(27, 28, 29);">ã€‚</font>

<font style="color:rgb(27, 28, 29);">GitHub Actions ä¸ºäº†å®‰å…¨ï¼Œä¸å…è®¸ CI/CD è„šæœ¬ </font>_<font style="color:rgb(27, 28, 29);">åˆ›å»º</font>_<font style="color:rgb(27, 28, 29);"> æˆ– </font>_<font style="color:rgb(27, 28, 29);">ä¿®æ”¹</font>_<font style="color:rgb(27, 28, 29);"> å®ƒè‡ªå·±çš„æœºå¯†ä¿¡æ¯ï¼ˆæ¯”å¦‚æ‚¨æœåŠ¡å™¨çš„ SSH å¯†é’¥ï¼‰ã€‚</font>

<font style="color:rgb(27, 28, 29);">æ‚¨éœ€è¦</font>**<font style="color:rgb(27, 28, 29);">æ‰‹åŠ¨åœ¨ GitHub ä»“åº“ä¸­è®¾ç½®ä¸€æ¬¡</font>**<font style="color:rgb(27, 28, 29);">è¿™äº›å˜é‡ï¼Œç„¶åä¸Šé¢ </font>`<font style="color:rgb(68, 71, 70);">deploy.yml</font>`<font style="color:rgb(27, 28, 29);"> è„šæœ¬å°±èƒ½åœ¨</font>**<font style="color:rgb(27, 28, 29);">æ¯æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨è¯»å–</font>**<font style="color:rgb(27, 28, 29);">å®ƒä»¬äº†ã€‚</font>

#### <font style="color:rgb(27, 28, 29);">è¯·æ‚¨åœ¨ </font>`<font style="color:rgb(68, 71, 70);">xipilabs-gateway</font>`<font style="color:rgb(27, 28, 29);"> ä»“åº“ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</font>
1. <font style="color:rgb(27, 28, 29);">è¿›å…¥ä»“åº“è®¾ç½®ï¼š</font>

<font style="color:rgb(27, 28, 29);">æ‰“å¼€ https://github.com/æ‚¨çš„ç”¨æˆ·å/xipilabs-gateway</font>

<font style="color:rgb(27, 28, 29);">ç‚¹å‡»å³ä¸Šè§’çš„ Settings (è®¾ç½®)ã€‚</font>

2. <font style="color:rgb(27, 28, 29);">æ‰¾åˆ° Secrets and variablesï¼š</font>

<font style="color:rgb(27, 28, 29);">åœ¨å·¦ä¾§èœå•ä¸­ï¼Œæ‰¾åˆ° Secrets and variables (æœºå¯†å’Œå˜é‡)ï¼Œç„¶åç‚¹å‡» Actionsã€‚</font>

3. **<font style="color:rgb(27, 28, 29);">åˆ›å»ºä»¥ä¸‹ 4 ä¸ªæœºå¯† (Secrets)ï¼š</font>**

<font style="color:rgb(27, 28, 29);">è¿™ä¸ªç•Œé¢æœ‰ä¸¤ä¸ªæ ‡ç­¾é¡µï¼šSecrets å’Œ Variablesã€‚</font>

<font style="color:rgb(27, 28, 29);">æ‚¨æä¾›çš„æ‰€æœ‰å˜é‡éƒ½åº”è®¾ä¸º Secretsï¼Œå³ä½¿å®ƒä»¬çœ‹èµ·æ¥ä¸â€œæœºå¯†â€ï¼ˆæ¯”å¦‚ç”¨æˆ·åå’Œè·¯å¾„ï¼‰ï¼Œè¿™æ˜¯æœ€ä½³å®è·µï¼Œå¯ä»¥é˜²æ­¢å®ƒä»¬åœ¨æ—¥å¿—ä¸­è¢«æ³„éœ²ã€‚</font>

<font style="color:rgb(27, 28, 29);">ç‚¹å‡» </font>**<font style="color:rgb(27, 28, 29);">New repository secret</font>**<font style="color:rgb(27, 28, 29);"> (æ–°å»ºä»“åº“æœºå¯†) æŒ‰é’®ï¼Œä¾æ¬¡åˆ›å»ºï¼š</font>

    - <font style="color:rgb(27, 28, 29);">Name: SERVER_HOST</font>

<font style="color:rgb(27, 28, 29);">Secret: 8.216.37.78</font>

    - <font style="color:rgb(27, 28, 29);">Name: SERVER_USER</font>

<font style="color:rgb(27, 28, 29);">Secret: deployer</font>

    - <font style="color:rgb(27, 28, 29);">Name: PROJECT_PATH</font>

<font style="color:rgb(27, 28, 29);">Secret: /workspace/gateway</font>

    - <font style="color:rgb(27, 28, 29);">Name: SERVER_SSH_KEY</font>

<font style="color:rgb(27, 28, 29);">Secret: (é‡è¦ï¼ åœ¨è¿™é‡Œç²˜è´´æ‚¨çš„ japan-server-key ç§é’¥æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ã€‚å®ƒé€šå¸¸ä»¥ -----BEGIN OPENSSH PRIVATE KEY----- å¼€å¤´ã€‚)</font>

---

**<font style="color:rgb(27, 28, 29);">é…ç½®å®Œæˆå</font>**<font style="color:rgb(27, 28, 29);">ï¼Œæ‚¨å°±å¯ä»¥è®© AI Coder å°†ä¸Šé¢é‚£ 3 ä¸ªæ–‡ä»¶ï¼ˆ</font>`<font style="color:rgb(68, 71, 70);">docker-compose.yml</font>`<font style="color:rgb(27, 28, 29);">, </font>`<font style="color:rgb(68, 71, 70);">nginx_config/xipilabs.conf</font>`<font style="color:rgb(27, 28, 29);">, </font>`<font style="color:rgb(68, 71, 70);">deploy.yml</font>`<font style="color:rgb(27, 28, 29);">ï¼‰æäº¤åˆ°æ‚¨çš„ </font>`<font style="color:rgb(68, 71, 70);">xipilabs-gateway</font>`<font style="color:rgb(27, 28, 29);"> ä»“åº“çš„ </font>`<font style="color:rgb(68, 71, 70);">main</font>`<font style="color:rgb(27, 28, 29);"> åˆ†æ”¯äº†ã€‚</font>

<font style="color:rgb(27, 28, 29);">ä¸€æ—¦æäº¤ï¼ŒGitHub Action å°±ä¼šè‡ªåŠ¨è§¦å‘ï¼Œå¹¶ä½¿ç”¨æ‚¨åˆšæ‰è®¾ç½®çš„ Secrets è‡ªåŠ¨éƒ¨ç½²åˆ°æ‚¨çš„æœåŠ¡å™¨ä¸Šã€‚</font>

<font style="color:rgb(27, 28, 29);"></font>

<font style="color:rgb(27, 28, 29);"></font>

# <font style="color:rgb(27, 28, 29);">è¯ä¹¦</font>
ä¸ºæ‚¨çš„ Nginx ç½‘å…³é…ç½® HTTPS (SSL è¯ä¹¦)

ä½¿ç”¨ **Certbot** å’Œ **Let's Encrypt** æ¥å®ç°ã€‚è¿™ä¼šä¸ºæ‚¨çš„æ‰€æœ‰åŸŸåï¼ˆ`xipilabs.com`, `www.xipilabs.com`, `taleweave.xipilabs.com`ï¼‰è‡ªåŠ¨ç”³è¯·å…è´¹è¯ä¹¦ï¼Œå¹¶ä¸”**è‡ªåŠ¨ç»­æœŸ**ã€‚

ç”±äº Nginx éœ€è¦å…ˆå¯åŠ¨ï¼ˆæ¥éªŒè¯åŸŸåï¼‰ï¼Œä½†åˆéœ€è¦è¯ä¹¦æ‰èƒ½å¯åŠ¨ HTTPSï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªâ€œå…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹â€çš„é—®é¢˜ã€‚æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ª**ä¸¤æ­¥éƒ¨ç½²**æ¥å®Œç¾è§£å†³å®ƒã€‚

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå…±äº«ç½‘ç»œ (æ‰‹åŠ¨æ“ä½œä¸€æ¬¡)
æ‚¨çš„ Nginx ç½‘å…³å’Œå…¶ä»–åº”ç”¨ï¼ˆ`www-app`, `taleweave-app`ï¼‰æ˜¯è·¨é¡¹ç›®çš„ã€‚å®ƒä»¬éœ€è¦ä¸€ä¸ªå…±äº«çš„ Docker ç½‘ç»œæ¥äº’ç›¸é€šä¿¡ã€‚

è¯·æ‚¨**ç™»å½•åˆ°æ‚¨çš„é˜¿é‡Œäº‘æœåŠ¡å™¨**ï¼Œå¹¶æ‰§è¡Œä¸€æ¬¡è¿™ä¸ªå‘½ä»¤ï¼Œæ¥åˆ›å»ºä¸€ä¸ªæŒä¹…çš„ã€å¯å…±äº«çš„ç½‘ç»œï¼š

Bash

```plain
docker network create xipi-network
```

---

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½² Certbot å¹¶è·å–è¯ä¹¦
åœ¨è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†ä¿®æ”¹æ‚¨çš„ `xipilabs-gateway` é¡¹ç›®ï¼Œæ·»åŠ  Certbot å®¹å™¨ï¼Œå¹¶è¿è¡Œå®ƒæ¥è·å–è¯ä¹¦ã€‚

#### 1. (æœ¬åœ°) åˆ›å»ºæ–°ç›®å½•
è¯·åœ¨æ‚¨æœ¬åœ°çš„ `xipilabs-gateway` ä»“åº“ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œç”¨äºå­˜æ”¾ Certbot çš„éªŒè¯æ–‡ä»¶ï¼š

Bash

```plain
mkdir -p data/certbot/www
```

(æ‚¨å¯èƒ½éœ€è¦åœ¨è¿™ä¸ªæ–°ç›®å½•é‡Œæ”¾ä¸€ä¸ª `.gitkeep` ç©ºæ–‡ä»¶ï¼Œä»¥ä¾¿èƒ½æŠŠå®ƒæäº¤åˆ° git ä»“åº“)ã€‚

#### 2. (æœ¬åœ°) æ›´æ–° `docker-compose.yml`
è¯·ç”¨ä¸‹é¢çš„å†…å®¹**è¦†ç›–**æ‚¨çš„ `docker-compose.yml` æ–‡ä»¶ã€‚ **æ”¹åŠ¨ç‚¹ï¼š**

+ æ·»åŠ äº†æ–°çš„ `certbot` æœåŠ¡ã€‚
+ æ·»åŠ äº†æ–°çš„ `certbot-webroot` å·ï¼Œå¹¶æŒ‚è½½åˆ° Nginxã€‚
+ å°† `xipi-network` å£°æ˜ä¸º `external` (ä½¿ç”¨æˆ‘ä»¬ç¬¬ä¸€æ­¥åˆ›å»ºçš„ç½‘ç»œ)ã€‚

YAML

```plain
version: '3.8'

volumes:
  letsencrypt_certs: # å­˜å‚¨ SSL è¯ä¹¦
  certbot_webroot: # å­˜å‚¨ Certbot éªŒè¯æ–‡ä»¶

networks:
  xipi-network: # å£°æ˜å…±äº«ç½‘ç»œ
    external: true

services:
  # 1. ç½‘å…³ Nginx (æ€»å…¥å£)
  gateway-nginx:
    image: nginx:latest
    container_name: gateway-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Nginx é…ç½®
      - ./nginx_config:/etc/nginx/conf.d
      # å…±äº«çš„ SSL è¯ä¹¦
      - letsencrypt_certs:/etc/letsencrypt 
      # å…±äº«çš„ Certbot éªŒè¯ç›®å½•
      - certbot_webroot:/var/www/certbot 
    networks:
      - xipi-network
    restart: always

  # 2. Certbot (è¯ä¹¦ç”³è¯·å’Œç»­æœŸ)
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      # å…±äº«çš„ SSL è¯ä¹¦
      - letsencrypt_certs:/etc/letsencrypt
      # å…±äº«çš„ Certbot éªŒè¯ç›®å½•
      - certbot_webroot:/var/www/certbot
    # ç»­æœŸå‘½ä»¤
    command: renew --quiet --deploy-hook "docker-compose exec gateway-nginx nginx -s reload"
    networks:
      - xipi-network
```

#### 3. (æœ¬åœ°) æš‚æ—¶ä¿®æ”¹ Nginx é…ç½®
ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª**ä¸´æ—¶**çš„ Nginx é…ç½®ï¼Œå®ƒåªåœ¨ 80 ç«¯å£ä¸Šè¿è¡Œï¼Œ**ä½†å¢åŠ äº†å¯¹ Certbot éªŒè¯çš„æ”¯æŒ**ã€‚

è¯·ç”¨ä¸‹é¢çš„å†…å®¹**è¦†ç›–**æ‚¨çš„ `nginx_config/xipilabs.conf` æ–‡ä»¶ï¼š

Nginx

```plain
# --- ä¸´æ—¶é…ç½®ï¼šç”¨äº Certbot é¦–æ¬¡éªŒè¯ ---

# 1. å®˜ç½‘ (www.xipilabs.com å’Œ xipilabs.com)
server {
    listen 80;
    server_name www.xipilabs.com xipilabs.com;

    # å…³é”®ï¼šä¸º Certbot éªŒè¯æ·»åŠ çš„ location
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # å…¶ä»–æ‰€æœ‰è¯·æ±‚ç…§å¸¸è½¬å‘
    location / {
        proxy_pass http://www-app:8080; # å‡è®¾æ‚¨çš„å®˜ç½‘åº”ç”¨
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 2. Taleweave (taleweave.xipilabs.com)
server {
    listen 80;
    server_name taleweave.xipilabs.com;

    # å…³é”®ï¼šä¸º Certbot éªŒè¯æ·»åŠ çš„ location
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # å…¶ä»–æ‰€æœ‰è¯·æ±‚ç…§å¸¸è½¬å‘
    location / {
        proxy_pass http://taleweave-app:3000; # å‡è®¾æ‚¨çš„ Taleweave åº”ç”¨
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 4. (æœ¬åœ°) æäº¤å¹¶éƒ¨ç½²
ç°åœ¨ï¼Œè¯·å°†æ‚¨çš„ `docker-compose.yml`, `nginx_config/xipilabs.conf` å’Œæ–°åˆ›å»ºçš„ `data/` ç›®å½•**æäº¤å¹¶æ¨é€åˆ° GitHub**ã€‚

**é‡è¦æç¤ºï¼š** æ‚¨åœ¨ `docker-compose.yml` ä¸­å®šä¹‰çš„ `http://www-app:8080` å’Œ `http://taleweave-app:3000` æ˜¯æ‚¨å¦å¤–ä¸¤ä¸ªé¡¹ç›®çš„**æœåŠ¡å**ã€‚

è¯·ç¡®ä¿æ‚¨é‚£ä¸¤ä¸ªé¡¹ç›®çš„ GitHub Action éƒ¨ç½²æ—¶ï¼Œè¿è¡Œ Docker å®¹å™¨çš„å‘½ä»¤åŒ…å«äº† `--network xipi-network` å’Œ `--name www-app` (æˆ– `--name taleweave-app`)ï¼Œè¿™æ · Nginx æ‰èƒ½åœ¨å…±äº«ç½‘ç»œä¸­æ‰¾åˆ°å®ƒä»¬ã€‚

#### 5. (æœåŠ¡å™¨) æ‰‹åŠ¨è¿è¡Œ Certbot è·å–è¯ä¹¦
ç­‰å¾… GitHub Action éƒ¨ç½²å®Œæˆåã€‚

**å†æ¬¡ç™»å½•åˆ°æ‚¨çš„æœåŠ¡å™¨**ï¼Œè¿›å…¥éƒ¨ç½²ç›®å½•ï¼ˆ`/workspace/gateway`ï¼‰ï¼Œç„¶å**æ‰‹åŠ¨æ‰§è¡Œ**ä»¥ä¸‹å‘½ä»¤æ¥è·å–è¯ä¹¦ã€‚

(è¯·æŠŠ `YOUR_EMAIL@example.com` æ›¿æ¢æˆæ‚¨è‡ªå·±çš„é‚®ç®±)

Bash

```plain
cd /workspace/gateway

docker-compose run --rm certbot certonly \
    --webroot -w /var/www/certbot \
    --email YOUR_EMAIL@example.com \
    -d xipilabs.com \
    -d www.xipilabs.com \
    -d taleweave.xipilabs.com \
    --agree-tos \
    --non-interactive \
    --force-renewal
```

å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæ‚¨ä¼šçœ‹åˆ°â€œCongratulations!â€ï¼ˆæ­å–œï¼‰çš„æ¶ˆæ¯ã€‚è¯ä¹¦ç°åœ¨å·²ç»ä¿å­˜åœ¨ `letsencrypt_certs` å·ä¸­äº†ã€‚

---

### ç¬¬ä¸‰æ­¥ï¼šå¯ç”¨ HTTPS (æœ€ç»ˆé…ç½®)
ç°åœ¨æˆ‘ä»¬æœ‰è¯ä¹¦äº†ï¼Œå¯ä»¥å¯ç”¨ HTTPS äº†ã€‚

#### 1. (æœ¬åœ°) æ›´æ–° `nginx_config/xipilabs.conf`
è¯·ç”¨ä¸‹é¢è¿™ä»½**æœ€ç»ˆé…ç½®**æ¥**è¦†ç›–**æ‚¨çš„ `nginx_config/xipilabs.conf` æ–‡ä»¶ã€‚ **æ”¹åŠ¨ç‚¹ï¼š**

+ 80 ç«¯å£çš„ `server` å—ç°åœ¨**åªè´Ÿè´£ HTTP åˆ° HTTPS çš„ 301 é‡å®šå‘**ã€‚
+ æ–°å¢äº† 443 (HTTPS) ç«¯å£çš„ `server` å—ï¼Œå®ƒä»¬è´Ÿè´£ SSL è¯ä¹¦åŠ è½½å’ŒçœŸæ­£çš„ `proxy_pass`ã€‚

Nginx

```plain
# --- æœ€ç»ˆé…ç½®ï¼šå¯ç”¨ HTTPS ---

# 1. å®˜ç½‘ (xipilabs.com å’Œ www.xipilabs.com)
server {
    listen 80;
    server_name xipilabs.com www.xipilabs.com;

    # 1A. Certbot éªŒè¯
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 1B. å…¶ä»–æ‰€æœ‰ HTTP è¯·æ±‚éƒ½ 301 é‡å®šå‘åˆ° HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name xipilabs.com www.xipilabs.com;

    # SSL è¯ä¹¦è·¯å¾„ (Certbot ä¼šè‡ªåŠ¨ç®¡ç†)
    ssl_certificate /etc/letsencrypt/live/xipilabs.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xipilabs.com/privkey.pem;
    
    # SSL ä¼˜åŒ–é…ç½® (å¯é€‰)
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 1C. ä»£ç†åˆ°å®˜ç½‘åº”ç”¨
    location / {
        proxy_pass http://www-app:8080; # å‡è®¾æ‚¨çš„å®˜ç½‘åº”ç”¨
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}


# 2. Taleweave (taleweave.xipilabs.com)
server {
    listen 80;
    server_name taleweave.xipilabs.com;

    # 2A. Certbot éªŒè¯
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 2B. å…¶ä»–æ‰€æœ‰ HTTP è¯·æ±‚éƒ½ 301 é‡å®šå‘åˆ° HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name taleweave.xipilabs.com;

    # SSL è¯ä¹¦è·¯å¾„
    ssl_certificate /etc/letsencrypt/live/taleweave.xipilabs.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/taleweave.xipilabs.com/privkey.pem;
    
    # SSL ä¼˜åŒ–é…ç½® (å¯é€‰)
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # 2C. ä»£ç†åˆ° Taleweave åº”ç”¨
    location / {
        proxy_pass http://taleweave-app:3000; # å‡è®¾æ‚¨çš„ Taleweave åº”ç”¨
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**æ³¨æ„ï¼š** åœ¨ä¸Šé¢çš„é…ç½®ä¸­ï¼Œæˆ‘ä¸º `taleweave.xipilabs.com` ä½¿ç”¨äº†ç‹¬ç«‹çš„è¯ä¹¦è·¯å¾„ï¼ˆ`live/taleweave.xipilabs.com`ï¼‰ã€‚

ä½†æ‚¨åœ¨ç¬¬äºŒæ­¥ç¬¬ 5 ç‚¹çš„å‘½ä»¤ä¸­ï¼Œæ˜¯**æŠŠæ‰€æœ‰åŸŸåç”³è¯·åˆ°äº†ä¸€ä¸ªè¯ä¹¦é‡Œ**ï¼ˆ`live/xipilabs.com`ï¼‰ã€‚

**è¯·æ‚¨**å°† `taleweave.xipilabs.com` çš„ `server 443` å—ä¸­çš„ `ssl_certificate` å’Œ `ssl_certificate_key` è·¯å¾„ï¼Œ**ä¹Ÿæ”¹æˆ **`**live/xipilabs.com**`ï¼Œå’Œå®˜ç½‘çš„é…ç½®ä¿æŒä¸€è‡´ã€‚

#### 2. (æœ¬åœ°) æäº¤å¹¶éƒ¨ç½²
è¯·å°†è¿™ä¸ª**æœ€ç»ˆçš„ **`**nginx_config/xipilabs.conf**`** æ–‡ä»¶æäº¤å¹¶æ¨é€åˆ° GitHub**ã€‚

GitHub Action ä¼šè‡ªåŠ¨è¿è¡Œï¼Œæ‹‰å–æ–°é…ç½®ï¼Œå¹¶ `docker-compose exec gateway-nginx nginx -s reload`ã€‚

éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„æ‰€æœ‰ç½‘ç«™ç°åœ¨éƒ½åº”è¯¥**è‡ªåŠ¨è·³è½¬åˆ° HTTPS**ï¼Œå¹¶ä¸”æ˜¾ç¤ºå®‰å…¨é”æ ‡å¿—äº†ã€‚

æ‚¨ `docker-compose.yml` ä¸­çš„ `certbot` å®¹å™¨ä¼šåœ¨æ­¤åæ¯å¤©è‡ªåŠ¨æ£€æŸ¥è¯ä¹¦æ˜¯å¦éœ€è¦ç»­æœŸï¼Œå¦‚æœéœ€è¦ï¼Œå®ƒä¼šè‡ªåŠ¨ç»­æœŸå¹¶é‡è½½ Nginxï¼Œæ‚¨æ— éœ€å†åšä»»ä½•æ“ä½œã€‚

