services:
  # 1. 网关 Nginx (总入口)
  gateway-nginx:
    image: nginx:latest
    container_name: gateway-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # 挂载 Nginx 配置
      - ./nginx_config:/etc/nginx/conf.d
      # Certbot 生成的证书
      - ./data/certbot/conf:/etc/letsencrypt
      # Certbot HTTP-01 验证目录
      - ./data/certbot/www:/var/www/certbot
    extra_hosts:
      # 让容器内可通过 host.docker.internal 访问宿主机上的其它服务
      - "host.docker.internal:host-gateway"
    networks:
      - xipi-network
    restart: always

  # 证书申请/续期（需要时使用 docker compose run 调用）
  certbot:
    image: certbot/certbot:latest
    profiles: ["certbot"]
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    networks:
      - xipi-network

  # 2. 官网 (www.xipilabs.com)
  # 注意：这是示例，您需要确保您的 www-repo 部署时
  # 也将容器加入了 'xipi-network'
  www-app:
    profiles: ["examples"]
    image: xipilabs/www-image:latest # 示例：请替换成您真实的官网镜像
    container_name: www-app
    # 官网应用不需要暴露 ports 到主机
    # Nginx 通过内部网络访问它
    expose:
      - "3210" # 官网在容器内运行于 3210 端口
    networks:
      - xipi-network
    restart: always

  # 3. Taleweave (taleweave.xipilabs.com)
  taleweave-app:
    profiles: ["examples"]
    image: xipilabs/taleweave-image:latest # 示例：请替换成您真实的 Taleweave 镜像
    container_name: taleweave-app
    expose:
      - "3000" # Taleweave 在容器内运行于 3000 端口
    networks:
      - xipi-network
    restart: always

# 共享网络，让 Nginx 可以通过服务名访问应用
networks:
  xipi-network:
    driver: bridge
