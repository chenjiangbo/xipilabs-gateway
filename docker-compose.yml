services:
  # 1. 网关 Nginx (总入口)
  gateway-nginx:
    image: nginx:latest
    container_name: gateway-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # 挂载 Nginx 配置
      - ./nginx_config:/etc/nginx/conf.d
      # Certbot 生成的证书
      - ./data/certbot/conf:/etc/letsencrypt
      # Certbot HTTP-01 验证目录
      - ./data/certbot/www:/var/www/certbot
    extra_hosts:
      # 让容器内可通过 host.docker.internal 访问宿主机上的其它服务
      - "host.docker.internal:host-gateway"
    networks:
      - xipi-network
    restart: always
    depends_on:
      - auth_service # 确保 auth_service 先启动

  # 2. 新增的认证服务
  auth_service:
    build: ./auth_service
    container_name: auth_service
    restart: always
    networks:
      - xipi-network
    environment:
      # JWT_SECRET 需要通过 .env 文件或环境变量提供
      - JWT_SECRET=${JWT_SECRET}

  # 3. 证书申请/续期（需要时使用 docker compose run 调用）
  certbot:
    image: certbot/certbot:latest
    profiles: ["certbot"]
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    networks:
      - xipi-network

# 共享网络，让 Nginx 可以通过服务名访问应用
networks:
  xipi-network:
    external: true
